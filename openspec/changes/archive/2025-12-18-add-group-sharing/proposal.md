# Proposal: add-group-sharing

## Summary

为 Group 功能添加分享能力，允许用户将一个或多个 groups（及其 items）分享给其他用户或公开访问。本次实现聚焦于单个 group 的分享场景，支持两种分享模式：

1. **Public 分享**：生成公开链接，任何人无需登录即可查看分享的 group 及其 items
2. **Private 分享（邀请模式）**：通过邮件邀请特定用户，被邀请用户需登录后才能查看分享内容

## Motivation

当前 Group 功能仅支持个人使用，用户无法与团队成员或外部协作者共享配置数据（如环境变量、API keys 集合等）。添加分享功能可以：

- **协作需求**：团队成员需要共享配置集合，避免重复手动输入
- **外部分享**：向客户或合作伙伴提供只读访问权限
- **灵活性**：支持公开和私有两种分享模式，满足不同安全需求
- **可扩展性**：为未来支持多 group 分享、权限管理等功能奠定基础

## Scope

**包含：**
- 单个 group 的分享功能（一个分享对应一个 group）
- Public 分享模式（无需登录，只读访问）
- Private 分享模式（邀请用户，需登录，只读访问）
- 邮件邀请系统（发送邀请链接，接受/拒绝邀请）
- 分享管理界面（创建、查看、撤销分享）
- 分享访问界面（查看分享的 group 和 items）
- 分享链接生成和验证机制

**不包含：**
- 多 group 批量分享（未来扩展）
- 编辑权限（本次仅支持只读）
- 分享过期时间（未来扩展）
- 分享访问统计（未来扩展）
- 细粒度权限控制（如仅分享部分 items）

## Affected Capabilities

**新增：**
- `group-sharing` - Group 分享核心功能
- `share-invitation` - 邀请系统和邮件通知
- `share-access` - 分享访问和权限验证

**修改：**
- `group-management` - 在 group 列表和详情页添加分享入口

## Dependencies

**技术依赖：**
- 邮件发送服务（建议使用 Resend 或 Nodemailer）
- 唯一分享链接生成（使用 nanoid 或 uuid）
- 邮件模板系统（HTML 邮件）

**功能依赖：**
- 依赖现有的 `group-management` 功能
- 依赖 NextAuth.js 用户认证系统

## Open Questions

1. **邮件服务选择**：使用 Resend（推荐，简单易用）还是 Nodemailer（需配置 SMTP）？
2. **分享链接格式**：`/share/{shareId}` 还是 `/s/{shareId}`（更短）？
3. **邀请接受流程**：
   - 用户点击邮件链接后，是否需要显式"接受邀请"按钮？
   - 还是点击链接即自动接受（如果已登录）？
4. **邀请用户验证**：
   - 邀请时是否验证邮箱是否已注册？
   - 未注册用户是否需要先注册才能接受邀请？
5. **分享撤销影响**：
   - 撤销分享后，已接受邀请的用户是否立即失去访问权限？
   - 是否需要通知被撤销访问的用户？
6. **Public 分享安全性**：
   - 是否需要添加"防爬虫"机制（如 rate limiting）？
   - 是否需要在 UI 上明确警告用户不要分享敏感数据？

## Risks

**安全风险：**
- **数据泄露**：Public 分享链接可能被意外传播，导致敏感数据泄露
  - 缓解：在创建 public 分享时显示明确警告
  - 缓解：提供快速撤销分享的功能
- **邮件伪造**：恶意用户可能伪造邀请邮件
  - 缓解：使用加密的 token 验证邀请链接
  - 缓解：邮件中显示邀请者信息供验证

**技术风险：**
- **邮件送达率**：邀请邮件可能被标记为垃圾邮件
  - 缓解：使用可靠的邮件服务（Resend）
  - 缓解：配置 SPF/DKIM 记录
- **链接唯一性冲突**：分享 ID 生成可能冲突
  - 缓解：使用 nanoid（21 字符，碰撞概率极低）
  - 缓解：数据库唯一约束

**用户体验风险：**
- **邀请流程复杂**：用户可能不理解邀请接受流程
  - 缓解：提供清晰的邮件说明和 UI 引导
- **权限混淆**：用户可能误以为分享是双向的（可编辑）
  - 缓解：在 UI 上明确标注"只读"

## Success Criteria

**功能完整性：**
- [ ] 用户可以创建 public 分享并生成链接
- [ ] 用户可以创建 private 分享并邀请特定邮箱
- [ ] 被邀请用户收到邮件并可以接受/拒绝邀请
- [ ] Public 分享链接可以在未登录状态下访问
- [ ] Private 分享链接需要登录且被邀请才能访问
- [ ] 用户可以查看自己创建的所有分享
- [ ] 用户可以撤销分享，撤销后链接立即失效
- [ ] 分享访问页面正确显示 group 和 items（只读）

**安全性：**
- [ ] 所有分享操作验证用户身份和所有权
- [ ] Public 分享不泄露用户信息
- [ ] Private 分享仅对被邀请用户可见
- [ ] 分享链接使用不可预测的 ID

**用户体验：**
- [ ] 分享创建流程简单直观（≤3 步）
- [ ] 邮件邀请内容清晰易懂
- [ ] 分享访问页面加载速度快（<2s）
- [ ] 移动端适配良好

## Related Changes

**未来扩展：**
- `add-multi-group-sharing` - 支持一次分享多个 groups
- `add-share-permissions` - 添加编辑权限和细粒度控制
- `add-share-expiration` - 分享过期时间和自动撤销
- `add-share-analytics` - 分享访问统计和日志

<!--
同步影响报告 (Sync Impact Report)
================================================================================
版本变更: 无 → 1.0.0
原因: 首次制定项目章程

新增章节:
- 核心原则 (5个原则)
  1. 代码质量优先
  2. 严格的测试标准
  3. 用户体验一致性
  4. 性能与安全要求
  5. 类型安全与可维护性

- 开发约束
- 代码审查与质量门禁
- 治理规则

模板更新状态:
- ✅ .specify/templates/plan-template.md - 已验证兼容
- ✅ .specify/templates/spec-template.md - 已验证兼容
- ✅ .specify/templates/tasks-template.md - 已验证兼容

待办事项: 无
================================================================================
-->

# Key Management System 项目章程

## 核心原则

### I. 代码质量优先 (Code Quality First)

**原则声明:**

项目中的所有代码**必须**遵循以下质量标准,不得妥协:

- **TypeScript 严格模式**: 必须启用 `strict: true`,不允许使用 `any` 类型(除非有充分理由并附带注释说明)
- **ESLint 零警告**: 所有代码提交前必须通过 ESLint 检查,无警告无错误
- **组件职责单一**: 每个组件/函数只负责一件事,保持简洁(函数不超过 50 行,组件不超过 200 行)
- **命名规范**: 使用描述性命名,避免缩写(除非是行业标准如 API、URL、ID)
- **无重复代码**: DRY 原则,相同逻辑出现 3 次以上必须抽取为可复用函数/组件
- **即时重构**: 发现代码异味(code smell)必须立即重构,不允许"稍后再改"

**理由**: 高质量代码减少 bug、提高可维护性、降低技术债务。本项目涉及敏感的 API 密钥管理,代码质量直接影响安全性。

---

### II. 严格的测试标准 (Rigorous Testing Standards)

**原则声明:**

测试是可选的,但如果实施测试,则**必须**遵循以下标准:

- **测试优先思维**: 在实现功能前,先思考如何测试该功能(即使不写自动化测试,也要有手动测试计划)
- **关键路径测试**: 以下场景必须有明确的测试验证(自动化或文档化的手动测试):
  - 认证流程(Google OAuth 登录/登出)
  - 用户隔离(确保用户只能访问自己的数据)
  - CRUD 操作(Providers 和 Tokens 的增删改查)
  - 错误处理(401、404、500 等错误响应)
- **边界条件验证**: 测试空值、超长字符串、特殊字符、并发操作等边界情况
- **数据库迁移测试**: 每次 schema 变更必须在本地和测试环境验证迁移成功
- **回归测试检查表**: 每次重大更改后必须执行回归测试检查表(见文档)

**测试类型优先级**(如果要添加自动化测试):

1. **集成测试**: API 路由的端到端测试(优先级最高)
2. **组件测试**: 关键 UI 组件的行为测试
3. **单元测试**: 复杂业务逻辑函数的单元测试(优先级较低)

**理由**: 敏感数据管理应用必须保证数据安全和用户隔离。测试确保功能正确性,防止数据泄露和安全漏洞。

---

### III. 用户体验一致性 (User Experience Consistency)

**原则声明:**

所有用户界面和交互**必须**保持一致性,遵循以下规范:

- **shadcn/ui 组件库**: 所有 UI 组件必须使用 shadcn/ui,不得引入其他 UI 库(避免样式冲突)
- **设计系统遵循**: 严格遵循项目的设计令牌(design tokens)定义:
  - 颜色: 使用 CSS 变量(`--background`, `--foreground` 等),不得硬编码颜色值
  - 间距: 使用 Tailwind 的间距 scale(`space-4`, `gap-6` 等)
  - 圆角: 使用统一的 `rounded-lg`、`rounded-md` 等
  - 字体: 使用 Tailwind 的字体大小(`text-sm`, `text-base` 等)
- **交互反馈**: 所有用户操作必须有明确反馈:
  - 加载状态: 显示 loading spinner 或 skeleton
  - 成功提示: 使用 toast 或 alert 提示成功(目前使用 `alert()`,后续可升级为 toast)
  - 错误提示: 清晰的错误信息,告知用户如何解决
- **无障碍性(Accessibility)**: 遵循 WCAG 2.1 AA 标准:
  - 所有交互元素必须键盘可访问
  - 表单必须有正确的 label 和 aria 属性
  - 颜色对比度符合标准
- **响应式设计**: 所有页面必须在移动端(320px+)、平板(768px+)、桌面(1024px+)上正常显示

**理由**: 一致的用户体验提升用户满意度,减少学习成本。无障碍性确保所有用户都能使用应用。

---

### IV. 性能与安全要求 (Performance & Security Requirements)

**原则声明:**

性能和安全是不可妥协的,必须满足以下标准:

#### 性能要求

- **页面加载**: 首次内容绘制(FCP)< 1.5s,最大内容绘制(LCP)< 2.5s
- **API 响应**: P95 响应时间 < 300ms(不含网络延迟)
- **数据库查询**: 所有查询必须有适当的索引,避免全表扫描
- **React Server Components**: 优先使用 RSC 减少客户端 JavaScript
- **懒加载**: 非首屏组件使用 `dynamic()` 懒加载
- **图片优化**: 使用 Next.js `<Image>` 组件,自动优化图片

#### 安全要求(非协商)

- **用户隔离**: 所有数据库查询必须包含 `userId` 过滤,防止数据泄露
- **输入验证**: 所有用户输入必须使用 Zod schema 验证(前端+后端双重验证)
- **SQL 注入防护**: 使用 Drizzle ORM 的参数化查询,不得拼接 SQL 字符串
- **XSS 防护**: React 自动转义,但不得使用 `dangerouslySetInnerHTML`(除非绝对必要且经过审查)
- **CSRF 防护**: NextAuth.js 自动处理,不得禁用 CSRF 保护
- **敏感数据处理**:
  - Token 在 UI 中默认遮盖(显示最后 4 位字符)
  - Token 不得记录到日志或错误消息中
  - 环境变量不得提交到 Git(已配置 `.gitignore`)
- **依赖安全**: 定期运行 `pnpm audit`,及时修复安全漏洞

**理由**: 性能影响用户体验和 SEO。安全漏洞可能导致用户数据泄露,造成严重后果。

---

### V. 类型安全与可维护性 (Type Safety & Maintainability)

**原则声明:**

代码必须充分利用 TypeScript 的类型系统,保持长期可维护性:

- **Drizzle 类型推导**: 使用 Drizzle 的 `InferSelectModel` 和 `InferInsertModel` 自动推导类型,不得手动定义数据库模型类型
- **Zod Schema 复用**: 表单验证的 Zod schema 必须导出并复用于 API 路由验证
- **NextAuth 类型扩展**: 使用 TypeScript module augmentation 扩展 NextAuth 类型(已在 `types/next-auth.d.ts` 中实现)
- **React Server Components 类型**: 正确标注 `async` 组件和 `Promise<Props>`
- **API 路由类型**: 使用 NextResponse 的泛型明确 API 返回类型
- **避免类型断言**: 不得滥用 `as` 断言,除非绝对必要且附带注释说明原因
- **文档化复杂逻辑**: 复杂的业务逻辑必须有 JSDoc 注释说明输入、输出、副作用

**可维护性实践:**

- **单一真相源**: 数据库 schema (`lib/db/schema.ts`) 是数据结构的唯一真相源
- **集中配置**: 环境变量在 `.env.example` 中文档化,配置逻辑在专门文件中
- **明确依赖**: 使用 pnpm workspace(如果扩展为 monorepo),避免隐式依赖
- **版本锁定**: 使用 `pnpm-lock.yaml` 锁定依赖版本,避免"在我机器上能跑"问题
- **迁移可追溯**: 数据库迁移文件必须保留,按时间顺序命名,不得修改已应用的迁移

**理由**: 类型安全在编译时捕获错误,减少运行时 bug。良好的可维护性降低新人上手成本,延长项目生命周期。

---

## 开发约束

### 技术栈约束(不可变更)

**必须使用:**

- **框架**: Next.js 16+ (App Router,不得使用 Pages Router)
- **React**: 19.2.0+
- **数据库**: Supabase PostgreSQL
- **ORM**: Drizzle ORM(不得使用 Prisma 或其他 ORM)
- **认证**: NextAuth.js v5
- **UI 库**: shadcn/ui + Tailwind CSS v4
- **表单**: React Hook Form + Zod
- **包管理**: pnpm(不得使用 npm 或 yarn)

**禁止引入:**

- 其他 UI 框架(如 Material-UI、Ant Design)
- 全局状态管理库(如 Redux、Zustand),除非有充分理由
- CSS-in-JS 库(如 styled-components),使用 Tailwind 即可
- 重量级依赖(bundle size > 100KB),除非绝对必要

### 文件组织约束

- **路由**: 所有路由在 `app/` 目录,遵循 Next.js App Router 约定
- **组件**: `components/` 目录按功能模块划分(`providers/`, `tokens/`, `layout/`, `ui/`)
- **工具函数**: `lib/` 目录,按功能分文件(`lib/db/`, `lib/utils.ts`)
- **类型定义**: `types/` 目录,按模块分文件
- **配置文件**: 根目录,命名清晰(`drizzle.config.ts`, `auth.ts` 等)

### Git 工作流约束

- **分支命名**: `feature/功能名`、`bugfix/问题描述`、`hotfix/紧急修复`
- **提交消息**: 遵循 Conventional Commits 规范:
  - `feat: 添加用户导出功能`
  - `fix: 修复 token 遮盖显示错误`
  - `refactor: 重构认证中间件`
  - `docs: 更新 README 环境变量说明`
- **提交频率**: 每完成一个小功能或修复一个 bug 立即提交,不得积累大量更改
- **代码审查**: 所有合并到主分支的代码必须经过审查(即使是单人项目,也要自我审查)

---

## 代码审查与质量门禁

### 合并前检查清单

每次合并代码到主分支前,必须确认以下检查项全部通过:

- [ ] **ESLint 通过**: `pnpm lint` 无错误无警告
- [ ] **TypeScript 编译通过**: `pnpm build` 成功
- [ ] **本地测试通过**: 手动测试所有变更的功能(如有自动化测试则运行测试套件)
- [ ] **用户隔离验证**: 如涉及数据查询,已验证用户只能访问自己的数据
- [ ] **数据库迁移测试**: 如有 schema 变更,已在本地应用迁移并验证
- [ ] **无安全漏洞**: 已检查 SQL 注入、XSS、CSRF 等常见漏洞
- [ ] **响应式测试**: 已在移动端和桌面端测试 UI(如有 UI 变更)
- [ ] **性能检查**: 已验证无明显性能退化(页面加载时间、API 响应时间)
- [ ] **文档更新**: 如有新功能或 API 变更,已更新 CLAUDE.md 或 README.md

### 代码审查关注点

审查代码时,重点关注以下方面:

1. **安全性**: 是否有数据泄露风险?用户隔离是否正确?
2. **类型安全**: 是否滥用 `any`?类型推导是否正确?
3. **性能**: 是否有不必要的 re-render?数据库查询是否高效?
4. **可维护性**: 代码是否易读?是否有足够的注释?
5. **一致性**: 是否遵循项目现有的代码风格和架构模式?

---

## 治理规则

### 章程地位

- 本章程是项目开发的**最高准则**,优先级高于所有其他文档和实践
- 所有团队成员(包括 AI 助手)必须遵守本章程
- 如发现章程与实际需求冲突,必须先修订章程,再调整实践

### 章程修订流程

1. **提出修订**: 任何人可提出修订建议,需说明修订原因和影响范围
2. **评审讨论**: 团队讨论修订的必要性和合理性
3. **版本更新**: 修订后更新版本号(遵循语义化版本):
   - **主版本(MAJOR)**: 移除或重新定义核心原则(向后不兼容)
   - **次版本(MINOR)**: 新增原则或章节,扩展现有指导
   - **修订版本(PATCH)**: 澄清措辞、修正错误、非语义性改进
4. **同步更新**: 修订后必须检查并更新所有依赖章程的模板和文档
5. **通知团队**: 修订完成后通知所有团队成员,确保知晓变更

### 合规性审查

- **定期审查**: 每月审查一次代码库是否符合章程要求
- **新人培训**: 新成员加入时必须学习本章程
- **持续改进**: 发现章程不合理之处,及时提出修订建议

### 复杂性辩护

如果某个功能或实现违反了本章程的某项原则(如引入新的 UI 库、使用 `any` 类型等),必须:

1. **充分说明理由**: 为什么现有方案不可行?
2. **评估替代方案**: 是否有更符合章程的替代方案?为什么被拒绝?
3. **记录决策**: 在代码中添加注释说明原因,在文档中记录决策过程
4. **设置期限**: 如果是临时方案,设定重构期限

---

## 运行时开发指导

**主要指导文档**: `CLAUDE.md`

- **架构说明**: 数据库 schema、认证流程、API 路由模式、组件架构
- **开发工作流**: 如何添加新功能、修改数据库、调试问题
- **常见任务**: 添加 shadcn/ui 组件、处理表单、数据库查询模式
- **陷阱避免**: 常见错误和最佳实践

所有开发工作应参考 `CLAUDE.md` 获取具体的实现指导。

---

**版本**: 1.0.0 | **批准日期**: 2025-12-02 | **最后修订**: 2025-12-02
